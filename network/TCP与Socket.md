# TCP与Socket

## TCP

TCP是一种面向连接的、可靠的、面向字节流的传输层通信协议，Socket通常被称作“套接字”，它是TPC的应用接口

### TCP通信过程

#### 基本过程

TCP通信过程与打电话过程大致相同。一方负责接听特定号码电话，另一方需要拨通这个这个电话，与对方建立通信连接。双方就可以通过听筒(socket输入输出流)接收与发送信息，这个过程中信息的接收与发送是同时进行的(双工通信)

#### 建立连接

打电话是，为了确认通话质量，我们常常这样做:

1. 甲: 喂，你好，听得到吗?
2. 乙: 喂，你好，听得到。你听得到我说话吗?
3. 甲: 恩，听得到

TCP建立连接时也是类似过程，俗称3次握手

1. 客户端发送SYN包(socket状态从closed 变成 syn-send)
2. 服务端接收此SYN包后(socket状态从closed 变成 syn-recv),然后向客户端发送针对此SYN包的SYN/ACK包,以确认收到了这个包
3. 客户端接收到此SYN/ACK包后(socket状态从syn-send变成establised)，再向服务端发送SYN/ACK的ACK包,服务端接收到后(socket状态从syn-recv变成establised)

为什么要三次？

* 第一次客户端初始发送，第二次是服务端发送确认，第三次是客户端发送确认，这样才真正达到可靠连接

#### 全双工异步通信

建立连接后，通信双方都可以主动向对方发送数据并接收响应，同一个管道，双向道路

#### 断开连接

断开连接需要4次握手。过程如下：

1. 客户端发送FIN数据包，表示想断开连接.socket状态从establised变成 FIN_WAIT_1
2. 服务器收到FIN包后，发送ACK包，表示准备断开,socket从establised编程close_wait。客户端接收到ACK包后,Socket状态由FIN_WAIT_1变成FIN_WAIT_2，等待服务端发送确认断开的数据包
3. 服务端在准备完毕后向客户端发送FIN包，确认可以断开，其状态由close_wait编程last_ack,等待客户端确认
4. 客户端收到服务器的FIN包后，向服务器发送ACK包，确认可以断开，Socket状态从FIN_WAIT_2编程TIME_WAIT,服务端接收到ACK包后，断开连接关闭socket.客户端等待一段时间后才真正关闭socket.

上述中客户端等待一段时间再关闭的原因是:

* 服务端发送FIN包，在没收到ACK时都会重发，而客户端等待是为了保证ACK指令的发送成功
